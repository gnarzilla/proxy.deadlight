<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-g">
    <title>Deadlight Proxy Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background: #f4f4f4; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 960px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #111; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f8f8; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .status-card { background: #fdfdfd; padding: 15px; border-radius: 5px; border: 1px solid #eee; }
        .status-card h3 { margin-top: 0; font-size: 1rem; color: #555; }
        .status-card p { margin: 0; font-size: 1.5rem; font-weight: bold; color: #000; }
        code { background: #eee; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Deadlight Proxy</h1>

        <h2>Status</h2>
        <div id="status-grid" class="status-grid">
            <!-- Status cards will be generated here by JavaScript -->
            <p>Loading...</p>
        </div>

        <h2>Connections (<span id="active-connections-count">0</span>)</h2>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Remote</th>
                    <th>Protocol</th>
                    <th>TX</th>
                    <th>RX</th>
                </tr>
            </thead>
            <tbody id="connections-table-body">
                <!-- Connection rows will be generated here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // Helper function to format bytes
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Main function to update the dashboard
        async function updateDashboard() {
            try {
                // Fetch status and connections data in parallel
                const [statusRes, connectionsRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/connections')
                ]);

                if (!statusRes.ok || !connectionsRes.ok) {
                    throw new Error('Failed to fetch data from API');
                }

                const status = await statusRes.json();
                const connections = await connectionsRes.json();

                // === Update Status Grid ===
                const statusGrid = document.getElementById('status-grid');
                const uptimeMinutes = (status.uptime_seconds / 60).toFixed(2);
                statusGrid.innerHTML = `
                    <div class="status-card"><h3>Version</h3><p>${status.version}</p></div>
                    <div class="status-card"><h3>Uptime</h3><p>${uptimeMinutes} min</p></div>
                    <div class="status-card"><h3>Connections (Active/Total)</h3><p>${status.connections_active} / ${status.connections_total}</p></div>
                    <div class="status-card"><h3>Data Transferred</h3><p>${status.bytes_transferred_formatted}</p></div>
                    <div class="status-card"><h3>Plugins</h3><p>${status.plugins.join(', ')}</p></div>
                `;

                // === Update Connections Table ===
                document.getElementById('active-connections-count').textContent = connections.length;
                const connectionsTableBody = document.getElementById('connections-table-body');
                connectionsTableBody.innerHTML = ''; // Clear existing rows

                if (connections.length === 0) {
                    connectionsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No active connections.</td></tr>';
                } else {
                    connections.forEach(conn => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${conn.id}</td>
                            <td>${conn.remote}</td>
                            <td>${conn.proto}</td>
                            <td>${formatBytes(conn.tx)}</td>
                            <td>${formatBytes(conn.rx)}</td>
                        `;
                        connectionsTableBody.appendChild(row);
                    });
                }

            } catch (error) {
                console.error('Error updating dashboard:', error);
                document.getElementById('status-grid').innerHTML = `<p style="color:red;">Error loading data.</p>`;
            }
        }

        // Initial call and set interval to refresh every 2 seconds
        updateDashboard();
        setInterval(updateDashboard, 2000);
    </script>

</body>
</html>