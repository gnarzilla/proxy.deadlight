<!DOCTYPE html>
<html lang="en">
<head>
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEADLIGHT // CONSOLE</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Fallback for .ico -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    
    <style>
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-dim: #71717a;
            --accent: #f59e0b; /* Amber */
            --log-bg: #000000;
            
            /* Log Colors */
            --l-info: #3b82f6;
            --l-warn: #eab308;
            --l-err: #ef4444;
            --l-debug: #52525b;
            --l-time: #059669;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-size: 20px; letter-spacing: -1px; }
        .badge { 
            background: var(--accent); color: #000; 
            padding: 2px 8px; border-radius: 4px; 
            font-size: 12px; font-weight: bold; 
        }

        /* TOP GRID (Stats) */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 6px;
        }
        .card-label { color: var(--text-dim); font-size: 11px; text-transform: uppercase; margin-bottom: 5px; display: block;}
        .card-value { font-size: 24px; font-weight: 600; }

        /* MAIN CONTENT SPLIT */
        .workspace {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden; /* Important for scroll */
        }

        /* CONNECTIONS LIST (Left) */
        .conn-panel {
            flex: 1;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
        }
        .panel-head {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        .conn-list {
            overflow-y: auto;
            flex: 1;
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .conn-row {
            padding: 8px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            display: grid;
            grid-template-columns: 40px 1fr 80px;
            gap: 10px;
            align-items: center;
        }
        .conn-row:hover { background: #27272a; }
        .method { color: var(--accent); font-weight: bold; }

        /* LOG TERMINAL (Right) */
        .terminal-panel {
            flex: 2;
            background: var(--log-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            font-size: 12px;
        }
        .terminal-window {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
        }
        
        /* Log Syntax Highlighting */
        .log-line { display: block; margin-bottom: 2px; line-height: 1.4; border-left: 2px solid transparent; padding-left: 5px;}
        .log-line:hover { background: #111; border-left-color: var(--text-dim); }
        
        .ts { color: var(--l-time); opacity: 0.7; margin-right: 10px; }
        .lvl-INFO { color: var(--l-info); font-weight: bold; }
        .lvl-WARN { color: var(--l-warn); font-weight: bold; }
        .lvl-ERROR { color: var(--l-err); font-weight: bold; }
        .lvl-DEBUG { color: var(--l-debug); }
        .msg { color: var(--text-main); }
        
        /* Specific highlight for your keywords */
        .kwd-conn { color: #a5f3fc; } /* Connection IDs */
        .kwd-host { color: #fcd34d; } /* Hostnames */

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5 10 10 0 0 0-10 0 4 4 0 0 1-5-5 4 4 0 0 1-5-5z"></path>
                <path d="M12 22v-6"></path>
                <path d="M12 8V2"></path>
                <path d="M4.93 4.93l4.24 4.24"></path>
                <path d="M14.83 14.83l4.24 4.24"></path>
                <path d="M14.83 9.17l4.24-4.24"></path>
                <path d="M4.93 19.07l4.24-4.24"></path>
            </svg>
            <h1>DEADLIGHT <span style="opacity:0.5">//</span> PROXY</h1>
        </div>
        <div>
            <span class="badge">v1.0.0</span>
            <span class="badge" style="background:#333; color:#fff; margin-left:5px;">MESH: ONLINE</span>
        </div>
    </header>

    <!-- METRICS -->
    <div class="grid">
        <div class="card">
            <span class="card-label">Active Connections</span>
            <span class="card-value" id="val-active">--</span>
        </div>
        <div class="card">
            <span class="card-label">Total Handled</span>
            <span class="card-value" id="val-total">--</span>
        </div>
        <div class="card">
            <span class="card-label">Data Transferred</span>
            <span class="card-value" id="val-bytes">-- KB</span>
        </div>
        <div class="card">
            <span class="card-label">Uptime</span>
            <span class="card-value" id="val-uptime">--</span>
        </div>
    </div>

    <div class="workspace">
        <!-- LEFT: ACTIVE CONNECTIONS -->
        <div class="conn-panel">
            <div class="panel-head">
                <span>TUNNELS</span>
                <span style="font-size: 10px; opacity: 0.7">LIVE</span>
            </div>
            <ul class="conn-list" id="conn-list">
                <!-- Javascript will populate this -->
                <li class="conn-row" style="text-align:center; display:block; opacity:0.5; padding:20px;">
                    Waiting for telemetry...
                </li>
            </ul>
        </div>

        <!-- RIGHT: LIVE LOGS -->
        <div class="terminal-panel">
            <div class="panel-head">
                <span>SYSTEM LOG</span>
                <div style="display:flex; gap:10px;">
                    <label style="font-size:10px;"><input type="checkbox" checked id="auto-scroll"> AUTO-SCROLL</label>
                </div>
            </div>
            <div class="terminal-window" id="terminal">
                <!-- Javascript will populate this -->
            </div>
        </div>
    </div>

<script>
    // == CONFIG ==
    // Point this to your main Proxy Port (8080), NOT the UI port (8081)
    const API_BASE = 'http://127.0.0.1:8080'; 
    const API_STATS = API_BASE + '/api/metrics'; 
    const API_LOGS  = API_BASE + '/api/logs';
    
    // == UTILS ==
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatUptime(seconds) {
        if (!seconds) return "0s";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function renderLogLine(line) {
        // Regex: Date Time [LEVEL] Message
        // Loose matching for spacing
        const regex = /^(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})\s$$\s*([A-Z]+)\s*$$\s(.*)/;
        const match = line.match(regex);

        if (!match) return `<div class="log-line"><span class="msg">${line}</span></div>`;

        const [_, ts, level, msg] = match;
        const cleanLevel = level.trim(); 

        // Keyword Highlighting for the Cyberpunk look
        let richMsg = msg
            .replace(/(Connection \d+)/g, '<span style="color:#67e8f9">\$1</span>') // Cyan
            .replace(/([a-zA-Z0-9.-]+\.com:\d+)/g, '<span style="color:#fcd34d">\$1</span>') // Yellow
            .replace(/(direct:\/\/)/g, '<span style="color:#86efac">\$1</span>'); // Green

        // CSS classes must be defined in <style> (.lvl-INFO, etc)
        return `
            <div class="log-line">
                <span class="ts" style="color:#52525b; margin-right:10px">${ts}</span>
                <span class="lvl-${cleanLevel}">${level}</span>
                <span class="msg" style="margin-left:10px">${richMsg}</span>
            </div>
        `;
    }

    // == UPDATE LOOPS ==

    // 1. Fetch Stats
    async function updateStats() {
        try {
            const res = await fetch(API_STATS);
            if (!res.ok) throw new Error("API Offline");
            const data = await res.json();

            // DOM Updates
            document.getElementById('val-active').innerText = 
                data.active_connections + " / " + data.total_connections;
            
            document.getElementById('val-total').innerText = data.total_connections;
            document.getElementById('val-bytes').innerText = formatBytes(data.bytes_transferred);
            document.getElementById('val-uptime').innerText = formatUptime(data.uptime);

            // Render Active Protocols (Mapping 'protocols' object from api.c)
            // Since api.c returns counts, we visualize the breakdown here
            const list = document.getElementById('conn-list');
            let html = '';
            let hasActive = false;

            // Iterate over protocols (HTTP, HTTPS, SOCKS, etc)
            for (const [proto, stats] of Object.entries(data.protocols)) {
                if (stats.active > 0) {
                    hasActive = true;
                    html += `
                    <li class="conn-row">
                        <span style="color:#555">PRO</span>
                        <span style="font-weight:bold">${proto}</span>
                        <span class="method" style="text-align:right">${stats.active} ACTIVE</span>
                    </li>`;
                }
            }

            if (!hasActive) {
                 html = '<li class="conn-row" style="opacity:0.5; justify-content:center;">Waiting for traffic...</li>';
            }
            list.innerHTML = html;

        } catch (e) {
            console.warn("Stats fetch failed:", e);
            document.getElementById('val-active').innerText = "OFFLINE";
        }
    }

    // 2. Fetch Logs
    // We store the raw string of the last log we added to avoid duplicates
    let lastLogLine = ""; 

    async function updateLogs() {
        try {
            const res = await fetch(API_LOGS);
            if (!res.ok) return;
            
            const logs = await res.json();
            const term = document.getElementById('terminal');
            
            // LOGIC: Find where our last known log is in the new array, 
            // and only append what comes AFTER it.
            let newLogs = [];
            
            if (lastLogLine === "") {
                newLogs = logs; // First run, take all
            } else {
                const lastIndex = logs.indexOf(lastLogLine);
                if (lastIndex !== -1) {
                    // We found our last line, take everything after it
                    newLogs = logs.slice(lastIndex + 1);
                } else {
                    // Mismatch (buffer cycled completely?), take all
                    // Optional: could check timestamps to be smarter
                    newLogs = logs; 
                }
            }

            if (newLogs.length > 0) {
                // Update our tracker
                lastLogLine = logs[logs.length - 1];

                // Append to DOM
                newLogs.forEach(line => {
                    const el = document.createElement('div');
                    el.innerHTML = renderLogLine(line);
                    term.appendChild(el);
                });

                // Auto Scroll
                if(document.getElementById('auto-scroll').checked) {
                    term.scrollTop = term.scrollHeight;
                }
                
                // Cleanup DOM (keep max 500 lines to save RAM)
                while(term.childElementCount > 500) {
                    term.removeChild(term.firstChild);
                }
            }

        } catch(e) { console.warn("Log fetch error", e); }
    }

    // Start Loops
    // Update stats every second, logs every 500ms for responsiveness
    setInterval(updateStats, 5000);
    setInterval(updateLogs, 2000); 
    
    // Initial paint
    updateStats();
    updateLogs();
</script>
</body>
</html>